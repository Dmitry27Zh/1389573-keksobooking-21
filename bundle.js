(()=>{"use strict";!function(){const e=function(e,t){return e=Math.ceil(e),t=Math.floor(t),Math.floor(Math.random()*(t-e+1))+e};window.utils={isEnterEvent:function(e,t){"Enter"===e.key&&t()},isEscEvent:function(e,t){"Escape"===e.key&&t()},isMousedownEvent:function(e,t){0===e.button&&t()},getRandomIntInclusive:e,shuffleArray:function(t){const n=e(1,t.length);let o,i,r=t.slice(0,n),a=r.length-1;for(;0!==a;)i=e(0,a),o=r[a],r[a]=r[i],r[i]=o,a--;return r}}}(),window.move={add:function(e,t){let n={x:e.clientX,y:e.clientY};const o=function(e){const o={x:n.x-e.clientX,y:n.y-e.clientY};t(o),n={x:e.clientX,y:e.clientY}},i=function(e){e.preventDefault(),document.removeEventListener("mousemove",o),document.removeEventListener("mouseup",i)};document.addEventListener("mousemove",o),document.addEventListener("mouseup",i)}},function(){let e;window.debounce=function(t){e&&window.clearTimeout(e),e=window.setTimeout(t,500)}}(),function(){const e={get:"https://21.javascript.pages.academy/keksobooking/data",POST:"https://21.javascript.pages.academy/keksobooking"},t=function(t){const n=new XMLHttpRequest;return n.open(t,e[t]),n.responseType="json",n};window.backend={load:function(e,n){const o=t("get");o.send(),o.addEventListener("load",(function(){e(o.response)})),o.addEventListener("error",(function(){n("Ошибка подключения к сети")}))},save:function(e,n,o){const i=t("POST");i.send(e),i.addEventListener("load",(function(){n()})),i.addEventListener("error",(function(){o()}))}}}(),function(){const e=document.querySelector(".map__pins"),t=document.querySelector("#pin").content.querySelector(".map__pin"),n=function(e){const n=t.cloneNode(!0);return n.style=`left: ${e.location.x-31}px; top: ${e.location.y-70}px;`,n.querySelector("img").src=e.author.avatar,n.querySelector("img").alt=e.offer.title,n};let o=[];const i=function(){e.querySelectorAll(".map__pin:not(.map__pin--main)").forEach((function(t){e.removeChild(t)}))},r=function(){const t=e.querySelector(".map__pin--active");t&&t.classList.remove("map__pin--active")};window.pin={mapPins:e,addPins:function(t){const r=document.createDocumentFragment(),a=t.length>5?5:t.length;for(let e=0;e<a;e++){const o=n(t[e]);o.setAttribute("data-index",e),r.appendChild(o)}i(),e.appendChild(r),o=t},removePins:i,adsList:o,mapPinClickHandler:function(e){let t;if(e.target.matches(".map__pin:not(.map__pin--active):not(.map__pin--main)"))t=e.target,r();else{if(!e.target.parentElement.matches(".map__pin:not(.map__pin--active):not(.map__pin--main)"))return;t=e.target.parentElement,r()}t.classList.add("map__pin--active");const n=t.getAttribute("data-index");window.card.createCard(o[n])},MAX_ADS_QUANTITY:5}}(),function(){let e=[],t=[],n=[];const o=function(e,t){let o=!1;return o=0===e.length||e.every((function(e){return function(e,t){const o=function(e){let t;return e.id.includes("housing-")?t=e.id.slice(8):e.id.includes("filter-")&&(t="features"),t}(e);let i=!1;return i="any"===e.value||("price"===o?function(e,t){let n=!1;return("middle"===e.value&&t>1e4&&t<5e4||"low"===e.value&&t<1e4||"high"===e.value&&t>5e4)&&(n=!0),n}(e,t.offer.price):"features"===o?function(e){return n.every((function(t){return e.offer.features.includes(t)}))}(t):String(t.offer[o])===e.value),i}(e,t)})),o};window.adsFiltration={getAds(t){e=t},mapFiltersInputHandler:function(i){if("features"===i.target.name)if(n.includes(i.target.value)){const e=n.indexOf(i.target.value);n.splice(e,1)}else n.push(i.target.value);if(t.includes(i.target)){if("any"===i.target.value&&t.includes(i.target)){const e=t.indexOf(i.target);t.splice(e,1)}}else t.push(i.target);!function(){let n=[];for(let i=0;i<e.length&&(o(t,e[i])&&n.push(e[i]),n.length!==window.pin.MAX_ADS_QUANTITY);i++);window.card.close(),window.debounce((function(){window.pin.addPins(n)}))}()}}}(),function(){const e=document.querySelector(".map"),t=window.pin.mapPins,n=e.querySelector(".map__filters-container"),o=n.querySelector(".map__filters"),i=o.querySelectorAll(".map__filter"),r=o.querySelector(".map__features"),a=function(t){window.adsFiltration.getAds(t),window.pin.addPins(t),e.classList.remove("map--faded"),i.forEach((function(e){e.removeAttribute("disabled")})),r.removeAttribute("disabled"),o.addEventListener("input",window.adsFiltration.mapFiltersInputHandler)},c=function(e){const t=document.createElement("div");t.style="z - index: 100; padding: 5px; border: 2px solid red; color: red; font - weight: bold",t.style.position="absolute",t.style.top="100px",t.style.left="50 % ",t.style.transform="translateX(-50 %)",t.style.fontSize="30px",t.textContent=e,document.body.insertAdjacentElement("afterbegin",t)};window.map={element:e,mapFiltersContainer:n,disableMap:function(){e.classList.add("map--faded"),window.pin.removePins(),window.mapPinMain.deactivate(),i.forEach((function(e){e.setAttribute("disabled",!0)})),r.setAttribute("disabled","true"),t.removeEventListener("click",window.pin.mapPinClickHandler)},enableMap:function(){window.backend.load(a,c),t.addEventListener("click",window.pin.mapPinClickHandler)}}}(),function(){const e=["palace","flat","house","bungalow"],t=["12:00","13:00","14:00"],n=["wifi","dishwasher","parking","washer","elevator","conditioner"],o=["http://o0.github.io/assets/images/tokyo/hotel1.jpg","http://o0.github.io/assets/images/tokyo/hotel2.jpg","http://o0.github.io/assets/images/tokyo/hotel3.jpg"],i=function(e){this.avatar=`img/avatars/user0${e}.png`},r=function(){this.title="заголовок",this.address="600, 350",this.price=100,this.type=e[window.utils.getRandomIntInclusive(0,e.length-1)],this.rooms=1,this.guests=1,this.checkin=t[window.utils.getRandomIntInclusive(0,t.length-1)],this.checkout=t[window.utils.getRandomIntInclusive(0,t.length-1)],this.features=window.utils.shuffleArray(n),this.description="описание",this.photos=window.utils.shuffleArray(o)},a=function(){this.x=window.utils.getRandomIntInclusive(1,window.pin.mapPins.offsetWidth-1),this.y=window.utils.getRandomIntInclusive(131,629)},c=function(e){this.author=new i(e),this.offer=new r,this.location=new a},s=function(){let e=[];for(let t=1;t<=8;t++){let n=new c(t);e.push(n)}return e}();window.data={ads:s}}(),function(){const e=document.querySelector(".ad-form"),t=e.querySelectorAll("fieldset"),n=e.querySelector("#type"),o=e.querySelector("#price"),i=e.querySelector("#room_number"),r=e.querySelector("#capacity"),a=e.querySelector("#timein"),c=e.querySelector("#timeout"),s=e.querySelector(".ad-form__element--time"),u=e.querySelector("#address"),d=e.querySelector(".ad-form__reset"),l=function(){u.value=`${window.mapPinMain.getCoordX()},\n    ${window.mapPinMain.getCoordY()}`},p={bungalow:"0",flat:"1000",house:"5000",palace:"10000"},f=function(){o.setAttribute("min",p[n.value]),o.setAttribute("placeholder",p[n.value])},m={1:[1],2:[1,2],3:[1,2,3],100:[0]},w=function(){return m[i.value].some((function(e){return Number(r.value)===e}))?r.setCustomValidity(""):r.setCustomValidity("Недопустимый вариант")},v=function(e){e.target===a?c.value=e.target.value:a.value=e.target.value},h=function(e){const t=document.querySelector("#"+e).content.querySelector("."+e).cloneNode("true");document.body.insertAdjacentElement("afterbegin",t),document.addEventListener("click",g),document.addEventListener("keydown",_)},y=function(){document.body.removeChild(document.body.children[0]),document.removeEventListener("click",g),document.removeEventListener("keydown",_)},g=function(){y()},_=function(e){window.utils.isEscEvent(e,y)},E=function(){h("error")},b=function(){h("success"),window.main.deactivateElements()},S=function(t){t.preventDefault(),window.backend.save(new FormData(e),b,E)},L=function(t){t.preventDefault(),e.reset(),window.main.deactivateElements()};window.adForm={disable:function(){t.forEach((function(e){e.setAttribute("disabled",!0)})),l(),n.removeEventListener("input",f),i.removeEventListener("input",w),r.removeEventListener("input",w),s.removeEventListener("input",v),e.removeEventListener("submit",S),d.removeEventListener("click",L)},enable:function(){e.classList.remove("ad-form--disabled"),t.forEach((function(e){e.removeAttribute("disabled")})),l(),f(),w(),n.addEventListener("input",f),i.addEventListener("input",w),r.addEventListener("input",w),s.addEventListener("input",v),e.addEventListener("submit",S),d.addEventListener("click",L)},fillAddress:l}}(),function(){const e=window.pin.mapPins.querySelector(".map__pin--main"),t=e.style.left,n=e.style.top,o=e.querySelector("img"),i={width:o.offsetWidth,height:o.offsetHeight+22,changeDeactivatedHeight(){this.height=o.offsetHeight+22},changeActivatedHeight(){this.height=o.offsetHeight/2}},r=function(t){window.utils.isMousedownEvent(t,(function(){window.map.element.classList.contains("map--faded")&&(window.main.activateElements(),e.removeEventListener("keydown",a)),function(t,n){(0,window.move.add)(t,(function(t){e.style.left=function(e,t){let n=e-t;const o=window.pin.mapPins.offsetWidth-i.Width;return n<0?n=0:n>o&&(n=o),n}(e.offsetLeft,t.x)+"px",e.style.top=function(e,t){let n=e-t;const o=131-i.height,r=639-i.height;return n<o?n=o:n>r&&(n=r),n}(e.offsetTop,t.y)+"px",window.adForm.fillAddress()}))}(t)}))},a=function(t){window.utils.isEnterEvent(t,(function(){window.main.activateElements(),e.removeEventListener("keydown",a)}))};window.mapPinMain={activate:function(){e.addEventListener("mousedown",r),e.addEventListener("keydown",a),i.changeActivatedHeight()},deactivate:function(){e.style.left=t,e.style.top=n,i.changeDeactivatedHeight()},getCoordX:function(){return Math.round(e.offsetLeft+i.width/2)},getCoordY:function(){return Math.round(e.offsetTop+i.height)}}}(),function(){const e=document.querySelector("#card").content.querySelector(".popup"),t={PALACE:"Дворец",FLAT:"Квартира",HOUSE:"Дом",BUNGALOW:"Бунгало"},n=function(){i()},o=function(e){window.utils.isEscEvent(e,(function(){i()}))},i=function(){const e=window.map.element.querySelector(".popup");e&&(e.querySelector(".popup__close").removeEventListener("click",n),document.removeEventListener("keydown",o),window.map.element.removeChild(e))};window.card={createCard:function(r){i();const a=e.cloneNode(!0);a.querySelector(".popup__avatar").src=r.author.avatar,a.querySelector(".popup__title").textContent=r.offer.title,a.querySelector(".popup__text--address").textContent=r.offer.address,a.querySelector(".popup__text--price").textContent=r.offer.price,a.querySelector(".popup__type").textContent=t[r.offer.type.toUpperCase()],a.querySelector(".popup__text--capacity").textContent=`${r.offer.rooms} комнаты для ${r.offer.guests} гостей`,a.querySelector(".popup__text--time").textContent=`Заезд после ${r.offer.checkin}, выезд до ${r.offer.checkout}`;const c=a.querySelectorAll(".popup__feature");for(let e of c)e.classList.add("hidden");r.offer.features.forEach((function(e){a.querySelector(".popup__feature--"+e).classList.remove("hidden")})),a.querySelector(".popup__description").textContent=r.offer.description;const s=a.querySelector(".popup__photos"),u=s.querySelector(".popup__photo");s.removeChild(u),r.offer.photos.forEach((function(e){const t=u.cloneNode(!0);t.src=e,s.appendChild(t)})),a.querySelector(".popup__close").addEventListener("click",n),document.addEventListener("keydown",o),window.map.element.insertBefore(a,window.map.mapFiltersContainer)},close:i}}(),function(){const e=function(){window.map.disableMap(),window.adForm.disable(),window.mapPinMain.activate()};e(),window.main={deactivateElements:e,activateElements:function(){window.map.enableMap(),window.adForm.enable()}}}()})();